---
title: PSEI Trading Range
author: Coconut Martin
date: '2019-02-02'
slug: PSEI-trading-range
categories:
  - charting
tags:
  - R
description: ''
repo: ''
weight: 0
---

```{r, include=FALSE}
library(tidyquant)
knitr::opts_chunk$set(echo=FALSE, message=FALSE)
x <- read.csv("C:/Users/Martin/Google Drive/7. Datasets/all shares px.csv") %>% mutate(Date = dmy(Date))
```

```{r, message=FALSE}
clean <- function(x) {ifelse(is.na(x), 0, x)}

previous_year <- 2018
target_year <- 2019
years_cutoff <- 10
filler_label <- paste0(as.character(previous_year - years_cutoff - 1), "-", as.character(previous_year - 1))

ticker <- c("PSEI")

wkly <- x %>% 
  select(Date, ticker) %>% 
  tq_transmute(mutate_fun = to.period,
               period = "week") %>% 
  mutate(yr = year(Date),
         mon = month.abb[month(Date)],
         wk = week(Date)) %>% 
  filter(yr <= previous_year & yr >= (previous_year - years_cutoff)) %>% 
  gather(key, value, -c(Date, yr, mon, wk)) %>% 
  group_by(yr, key) %>% 
  mutate(chg = cumprod(1 + clean(ROC(value, n = 1, type = "discrete"))) - 1) %>% 
  group_by(mon, wk, key) %>% 
  summarise(bottom = min(chg, na.rm = TRUE) * 100,
            top = max(chg, na.rm = TRUE) * 100) %>% 
  arrange(wk)
```

```{r, fig.width=6, message=FALSE}
tw18 <- x %>% 
  select(Date, ticker) %>% 
  tq_transmute(mutate_fun = to.period,
               period = "week") %>% 
  mutate(yr = year(Date),
         mon = month.abb[month(Date)],
         wk = week(Date)) %>% 
  filter(yr == 2018) %>% 
  gather(key, value, -c(Date, yr, mon, wk)) %>% 
  group_by(yr, key) %>% 
  mutate(total.2018 = (cumprod(1 + clean(ROC(value, n = 1, type = "discrete"))) - 1) * 100) %>% 
  ungroup() %>% 
  select(mon, wk, total.2018, key)
  
tw19 <- x %>% 
  select(Date, ticker) %>% 
  tq_transmute(mutate_fun = to.period,
               period = "week") %>% 
  mutate(yr = year(Date),
         mon = month.abb[month(Date)],
         wk = week(Date)) %>% 
  filter(yr == 2019) %>% 
  gather(key, value, -c(Date, yr, mon, wk)) %>% 
  group_by(yr, key) %>% 
  mutate(total.2019 = (cumprod(1 + clean(ROC(value, n = 1, type = "discrete"))) - 1) * 100) %>% 
  ungroup() %>% 
  select(mon, wk, total.2019, key)

plt <- tw18 %>% 
  left_join(., tw19) %>% 
  left_join(., wkly) %>% 
  mutate(Date = as.Date(paste(2019, wk, 1, sep = "-"), "%Y-%U-%u")) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = total.2018, color = "2018"), linetype = "dashed") +
  geom_line(aes(y = total.2019, color = "2019"), size = 1.1) +
  geom_line(aes(y = 0), color = "grey20", linetype = "dotted") +
  geom_ribbon(aes(ymin = bottom, ymax = top), fill = "red", alpha = 0.10) +
  labs(title = paste0(ticker, " Historical Range from ", previous_year - years_cutoff, " to ", previous_year),
       x = "",
       y = "Returns [%]") +
  theme_tq() + 
  scale_color_manual(values = c("grey20", "#C00000"), name = "Year") +
  scale_x_date(date_labels = "%b", date_breaks = "2 month") +
  theme(panel.grid = element_blank()) +
  facet_wrap(~key, scales = "free")

plotly::ggplotly(plt) %>% 
  plotly::layout(title = paste0(ticker, " Historical Range from ", previous_year - years_cutoff, " to ", previous_year))
```

